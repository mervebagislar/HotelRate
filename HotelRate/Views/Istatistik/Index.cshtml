@model List<HotelRate2.Models.ViewModels.OtelIstatistikViewModel>
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@using System.Text.Json
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>HotelRate - İstatistikler</title>
    <meta content="" name="description">
    <meta content="" name="keywords">
    <!-- Favicons -->
    <link href="/img/bannerIcon.png" rel="icon">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,600;1,700&family=Inter:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&family=Cardo:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <!-- Vendor CSS Files -->
    <link href="/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">
    <link href="/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
    <link href="/vendor/aos/aos.css" rel="stylesheet">
    <!-- Template Main CSS File -->
    <link href="/css/main.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --color-primary: #27a776;
            --color-primary-hover: #32cf93;
            --color-secondary: #161718;
            --color-text: #fafafa;
            --color-text-muted: rgba(255, 255, 255, 0.6);
            --color-bg-dark: #000;
            --color-bg-card: repeating-linear-gradient(rgba(0, 0, 0, 0.541), rgba(255, 255, 255, 0.205), rgba(0, 0, 0, 0.541));
            --color-border: rgba(255, 255, 255, 0.1);
            --color-star-filled: #fbc634;
            --color-star-empty: #cecece;
        }

        body {
            background-color: var(--color-bg-dark);
            color: var(--color-text);
        }

        .star-rating {
            display: inline-block;
        }
        .star-rating i {
            font-size: 1.2rem;
            color: var(--color-star-filled);
        }
        
        .stat-card {
            margin-bottom: 2rem;
            background: var(--color-bg-card);
            border-radius: 20px;
            color: whitesmoke;
            border: 1px solid var(--color-border);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(39, 167, 118, 0.2);
        }

        .stat-card hr {
            border-color: var(--color-border);
            opacity: 0.3;
        }

        .stat-card h4 {
            color: var(--color-text);
        }

        .chart-container {
            position: relative;
            height: 200px;
            margin-top: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 10px;
        }

        .soru-item {
            border-bottom: 1px solid var(--color-border);
            padding: 0.5rem 0;
        }
        .soru-item:last-child {
            border-bottom: none;
        }

        .accordion {
            --bs-accordion-bg: transparent;
            --bs-accordion-border-color: var(--color-border);
            --bs-accordion-active-bg: rgba(39, 167, 118, 0.1);
            --bs-accordion-btn-color: var(--color-text);
            --bs-accordion-btn-focus-box-shadow: 0 0 0 0.25rem rgba(39, 167, 118, 0.25);
        }

        .accordion-button {
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
            background-color: rgba(0, 0, 0, 0.3);
            color: var(--color-text);
            border-color: var(--color-border);
        }

        .accordion-button:not(.collapsed) {
            background-color: rgba(39, 167, 118, 0.15);
            color: var(--color-text);
            box-shadow: none;
        }

        .accordion-button:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 0.25rem rgba(39, 167, 118, 0.25);
        }

        .accordion-body {
            background-color: rgba(0, 0, 0, 0.2);
            color: var(--color-text);
        }

        .accordion-item {
            background-color: transparent;
            border-color: var(--color-border);
        }

        .btn-outline-primary {
            --bs-btn-color: var(--color-primary);
            --bs-btn-border-color: var(--color-primary);
            --bs-btn-hover-bg: var(--color-primary);
            --bs-btn-hover-border-color: var(--color-primary);
            --bs-btn-active-bg: var(--color-primary);
            --bs-btn-active-border-color: var(--color-primary);
            --bs-btn-focus-shadow-rgb: 39, 167, 118;
        }

        .badge {
            font-weight: 500;
        }

        .badge.bg-primary {
            background-color: var(--color-primary) !important;
        }

        .badge.bg-info {
            background-color: rgba(39, 167, 118, 0.3) !important;
            color: var(--color-text) !important;
            border: 1px solid var(--color-primary);
        }

        .badge.bg-success {
            background-color: var(--color-primary) !important;
        }

        .badge.bg-danger {
            background-color: rgba(255, 99, 132, 0.8) !important;
        }

        .badge.bg-warning {
            background-color: rgba(255, 159, 64, 0.8) !important;
        }

        .alert-info {
            background-color: rgba(39, 167, 118, 0.1);
            border-color: var(--color-primary);
            color: var(--color-text);
        }

        .alert-secondary {
            background-color: rgba(255, 255, 255, 0.05);
            border-color: var(--color-border);
            color: var(--color-text-muted);
        }

        .small-ratings i {
            color: var(--color-star-filled);
        }

        .text-muted {
            color: var(--color-text-muted) !important;
        }

        .review-count {
            color: var(--color-text);
        }

        /* Chart.js dark mode */
        .chart-container canvas {
            filter: brightness(0.95);
        }

        /* Dark mode support */
        @@media (prefers-color-scheme: dark) {
            .stat-card {
                background: var(--color-bg-card);
            }
        }
    </style>
</head>
<body>
    <!-- ======= Header ======= -->
    <header id="header" class="header d-flex align-items-center fixed-top">
        <div class="container-fluid d-flex align-items-center justify-content-between">
            <!-- LOGO -->
            <a asp-controller="Giris" asp-action="Index"
               class="logo d-flex align-items-center me-auto me-lg-0">
                <img src="/img/bannerIcon.png" alt="HotelRate">
                <h1>HotelRate</h1>
            </a>
            <nav id="navbar" class="navbar px-4">
                <ul>
                    <li><a asp-controller="Anasayfa" asp-action="Index">Anasayfa</a></li>
                    <li><a asp-controller="Istatistik" asp-action="Index">İstatistik</a></li>
                    <li><a asp-controller="Iletisim" asp-action="Index">İletişim</a></li>
                </ul>
            </nav><!-- .navbar -->
            <i class="mobile-nav-toggle mobile-nav-show bi bi-list"></i>
            <i class="mobile-nav-toggle mobile-nav-hide d-none bi bi-x"></i>
        </div>
    </header>
    <main id="main" data-aos="fade" data-aos-delay="1500">
        <div class="page-header d-flex align-items-center">
            <div class="container position-relative">
                <div class="row d-flex justify-content-center">
                    <div class="col-lg-6 text-center">
                        <h2>İstatistikler</h2>
                        <p>Otellerden alınan anket cevaplarına göre dinamik istatistikler</p>
                        <img src="/img/gallery/starrate1.gif" class="img-fluid w-50" alt="">
                    </div>
                </div>
            </div>
        </div>

        <div class="container mt-5">
            @if (Model == null || !Model.Any())
            {
                <div class="alert alert-info text-center border border-primary">
                    <h4 class="text-white">Henüz istatistik bulunmamaktadır.</h4>
                    <p class="text-white-50 mb-0">Anket cevapları geldikçe istatistikler burada görüntülenecektir.</p>
                </div>
            }
            else
            {
                <div class="row">
                    @foreach (var otel in Model)
                    {
            <div class="col-xl-4 col-lg-6 mb-4">
                            <div class="card stat-card p-3 text-center">
                                <hr>
                                <h4 class="mb-3">@otel.OtelAdi</h4>
                                <hr>
                                
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div class="star-rating">
                                        @{
                                            var fullStars = (int)otel.GenelOrtalamaPuan;
                                            var hasHalfStar = otel.GenelOrtalamaPuan - fullStars >= 0.5;
                                        }
                                        @for (int i = 0; i < fullStars; i++)
                                        {
                                            <i class="bi bi-star-fill" style="color: var(--color-star-filled);"></i>
                                        }
                                        @if (hasHalfStar)
                                        {
                                            <i class="bi bi-star-half" style="color: var(--color-star-filled);"></i>
                                        }
                                        @for (int i = fullStars + (hasHalfStar ? 1 : 0); i < 5; i++)
                                        {
                                            <i class="bi bi-star" style="color: var(--color-star-empty);"></i>
                                        }
                        </div>
                                    <h5 class="review-count mb-0">
                                        @otel.ToplamCevapSayisi Oylama
                                    </h5>
                    </div>

                                <div class="mb-3">
                                    <strong>Genel Ortalama: </strong>
                                    <span class="badge bg-primary">@otel.GenelOrtalamaPuan.ToString("F2") / 5.00</span>
                    </div>

                                @if (otel.SoruIstatistikleri != null && otel.SoruIstatistikleri.Any())
                                {
                                    <div class="mt-4">
                                        <button class="btn btn-outline-primary btn-sm w-100 mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#detay-@otel.OtelId" aria-expanded="false" aria-controls="detay-@otel.OtelId" id="btn-detay-@otel.OtelId">
                                            <i class="bi bi-chevron-down" id="icon-detay-@otel.OtelId"></i> <span>Detaylı İstatistikleri Göster</span>
                                        </button>
                                        
                                        <div class="collapse" id="detay-@otel.OtelId">
                                            <div class="accordion" id="accordion-@otel.OtelId">
                                                @{ int soruIndex = 0; }
                                                @foreach (var soru in otel.SoruIstatistikleri)
                                                {
                                                    <div class="accordion-item">
                                                        <h2 class="accordion-header" id="heading-@otel.OtelId-@soruIndex">
                                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-@otel.OtelId-@soruIndex" aria-expanded="false" aria-controls="collapse-@otel.OtelId-@soruIndex">
                                                                <div class="d-flex justify-content-between align-items-center w-100 me-3">
                                                                    <span>@soru.SoruKonu</span>
                                                                    <span class="badge bg-info ms-2">@soru.OrtalamaPuan.ToString("F2")</span>
                        </div>
                                                            </button>
                                                        </h2>
                                                        <div id="collapse-@otel.OtelId-@soruIndex" class="accordion-collapse collapse" aria-labelledby="heading-@otel.OtelId-@soruIndex" data-bs-parent="#accordion-@otel.OtelId">
                                                            <div class="accordion-body">
                                                                @if (!string.IsNullOrEmpty(soru.SoruMetni))
                                                                {
                                                                    <p class="small text-muted mb-2">@soru.SoruMetni</p>
                                                                }
                                                                <div class="small-ratings mb-2">
                                                                    @{
                                                                        var soruFullStars = (int)soru.OrtalamaPuan;
                                                                        var soruHasHalfStar = soru.OrtalamaPuan - soruFullStars >= 0.5;
                                                                    }
                                                                    @for (int i = 0; i < soruFullStars; i++)
                                                                    {
                                                                        <i class="bi bi-star-fill" style="color: var(--color-star-filled);"></i>
                                                                    }
                                                                    @if (soruHasHalfStar)
                                                                    {
                                                                        <i class="bi bi-star-half" style="color: var(--color-star-filled);"></i>
                                                                    }
                                                                    @for (int i = soruFullStars + (soruHasHalfStar ? 1 : 0); i < 5; i++)
                                                                    {
                                                                        <i class="bi bi-star" style="color: var(--color-star-empty);"></i>
                                                                    }
                        </div>
                                                                <div class="small text-muted mb-2">
                                                                    <strong>@soru.CevapSayisi</strong> cevap alındı
                    </div>
                                                                <div class="small">
                                                                    <strong>Dağılım:</strong> 
                                                                    <span class="badge bg-danger">1: @soru.CevapDagilimi.BirPuanSayisi</span>
                                                                    <span class="badge bg-warning">2: @soru.CevapDagilimi.IkiPuanSayisi</span>
                                                                    <span class="badge bg-info">3: @soru.CevapDagilimi.UcPuanSayisi</span>
                                                                    <span class="badge bg-primary">4: @soru.CevapDagilimi.DortPuanSayisi</span>
                                                                    <span class="badge bg-success">5: @soru.CevapDagilimi.BesPuanSayisi</span>
                        </div>
                    </div>
                </div>
            </div>
                                                    soruIndex++;
                                                }
                    </div>

                                            <!-- Cevap Dağılım Grafiği -->
                                            <div class="chart-container mt-4">
                                                <canvas id="chart-@otel.OtelId"></canvas>
                        </div>
                    </div>
                </div>
                                }
                                else
                                {
                                    <div class="alert alert-secondary mt-3">
                                        <small>Bu otel için henüz soru bazlı istatistik bulunmamaktadır.</small>
                        </div>
                                }
            </div>
                        </div>
                    }
                </div>
            }
            </div>
    </main>
    <!-- End Header -->
    <!-- ======= Footer ======= -->
    <footer id="footer" class="footer">
        <div class="container">
            <div class="copyright">
                &copy; Copyright <strong><span>HotelRate</span></strong>. All Rights Reserved
            </div>
            <div class="credits">
                Designed by <a href="">Ekip Adı</a>
            </div>
        </div>
    </footer>
    <!-- End Footer -->
    <a href="#" class="scroll-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>
    <div id="preloader">
        <div class="line"></div>
    </div>
    <!-- Vendor JS Files -->
    <script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="/vendor/swiper/swiper-bundle.min.js"></script>
    <script src="/vendor/glightbox/js/glightbox.min.js"></script>
    <script src="/vendor/aos/aos.js"></script>
    <script src="/vendor/php-email-form/validate.js"></script>
    <!-- Template Main JS File -->
    <script src="/js/main.js"></script>
    
    <!-- Chart.js Initialization -->
    <script>
        @if (Model != null && Model.Any())
        {
            foreach (var otel in Model)
            {
                if (otel.SoruIstatistikleri != null && otel.SoruIstatistikleri.Any())
                {
                    // Toplam cevap dağılımını hesapla
                    var toplamBir = otel.SoruIstatistikleri.Sum(s => s.CevapDagilimi.BirPuanSayisi);
                    var toplamIki = otel.SoruIstatistikleri.Sum(s => s.CevapDagilimi.IkiPuanSayisi);
                    var toplamUc = otel.SoruIstatistikleri.Sum(s => s.CevapDagilimi.UcPuanSayisi);
                    var toplamDort = otel.SoruIstatistikleri.Sum(s => s.CevapDagilimi.DortPuanSayisi);
                    var toplamBes = otel.SoruIstatistikleri.Sum(s => s.CevapDagilimi.BesPuanSayisi);
                    
                    <text>
                    (function() {
                        var otelId = @otel.OtelId;
                        var ctx = document.getElementById('chart-' + otelId);
                        if (!ctx) return;
                        
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: ['1 Puan', '2 Puan', '3 Puan', '4 Puan', '5 Puan'],
                                datasets: [{
                                    label: 'Cevap Sayısı',
                                    data: [
                                        @toplamBir,
                                        @toplamIki,
                                        @toplamUc,
                                        @toplamDort,
                                        @toplamBes
                                    ],
                                    backgroundColor: [
                                        'rgba(255, 99, 132, 0.7)',
                                        'rgba(255, 159, 64, 0.7)',
                                        'rgba(251, 198, 52, 0.7)',
                                        'rgba(75, 192, 192, 0.7)',
                                        'rgba(39, 167, 118, 0.7)'
                                    ],
                                    borderColor: [
                                        'rgba(255, 99, 132, 1)',
                                        'rgba(255, 159, 64, 1)',
                                        'rgba(251, 198, 52, 1)',
                                        'rgba(75, 192, 192, 1)',
                                        'rgba(39, 167, 118, 1)'
                                    ],
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            stepSize: 1,
                                            color: 'rgba(255, 255, 255, 0.7)'
                                        },
                                        grid: {
                                            color: 'rgba(255, 255, 255, 0.1)'
                                        }
                                    },
                                    x: {
                                        ticks: {
                                            color: 'rgba(255, 255, 255, 0.7)'
                                        },
                                        grid: {
                                            color: 'rgba(255, 255, 255, 0.1)'
                                        }
                                    }
                                },
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    title: {
                                        display: true,
                                        text: @Html.Raw(JsonSerializer.Serialize(otel.OtelAdi + " - Toplam Cevap Dağılımı")),
                                        color: 'rgba(255, 255, 255, 0.9)',
                                        font: {
                                            size: 14,
                                            weight: 'bold'
                                        }
                                    }
                                }
                            }
                        });
                    })();
                    </text>
                }
            }
        }

        // Detay buton ikonlarını dinamik hale getir
        document.addEventListener('DOMContentLoaded', function() {
            @if (Model != null && Model.Any())
            {
                foreach (var otel in Model)
                {
                    if (otel.SoruIstatistikleri != null && otel.SoruIstatistikleri.Any())
                    {
                        <text>
                        (function() {
                            var otelId = @otel.OtelId;
                            var detayCollapse = document.getElementById('detay-' + otelId);
                            var detayBtn = document.getElementById('btn-detay-' + otelId);
                            var detayIcon = document.getElementById('icon-detay-' + otelId);
                            
                            if (detayCollapse && detayBtn && detayIcon) {
                                detayCollapse.addEventListener('show.bs.collapse', function () {
                                    detayIcon.classList.remove('bi-chevron-down');
                                    detayIcon.classList.add('bi-chevron-up');
                                    var span = detayBtn.querySelector('span');
                                    if (span) span.textContent = ' Detaylı İstatistikleri Gizle';
                                });
                                detayCollapse.addEventListener('hide.bs.collapse', function () {
                                    detayIcon.classList.remove('bi-chevron-up');
                                    detayIcon.classList.add('bi-chevron-down');
                                    var span = detayBtn.querySelector('span');
                                    if (span) span.textContent = ' Detaylı İstatistikleri Göster';
                                });
                            }
                        })();
                        </text>
                    }
                }
            }
        });
    </script>
</body>
</html>
